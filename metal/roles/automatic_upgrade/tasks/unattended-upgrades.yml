---
# Copyright 2023 Logicalis UKI. All Rights Reserved.
#
# Licensed under the Functional Source License, Version 1.0, Apache 2.0 Change License (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://github.com/logicalisuki/ubiquity/blob/main/LICENSE.md
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# It also allows for the transition of this software to an Apache 2.0 Licence
# on the second anniversary of the date we make the software available.
# See the License for the specific language governing permissions and
# limitations under the License.

# tasks file for unattended-upgrades - Debian
- name: "Debian | Add Debian Bullseye workaround"
  ansible.builtin.include_vars: "{{ ansible_distribution }}-{{ ansible_distribution_release }}.yml"
  when:
    - "ansible_distribution == 'Debian'"
    - "ansible_distribution_release == 'bullseye'"

- name: "Debian | Install powermgmt-base"
  ansible.builtin.apt:
    name: "powermgmt-base"
    state: present
    cache_valid_time: "{{ unattended_cache_valid_time }}"
    update_cache: "yes"
    force_apt_get: "yes"
  when: "unattended_only_on_ac_power"

- name: "Debian | Install unattended-upgrades"
  ansible.builtin.apt:
    name: "unattended-upgrades"
    state: present
    cache_valid_time: "{{ unattended_cache_valid_time }}"
    update_cache: 'yes'
    force_apt_get: 'yes'

- name: "Debian | Install reboot dependencies"
  ansible.builtin.import_tasks: 'reboot.yml'
  when: unattended_automatic_reboot | bool

- name: "Debian | Create apt auto-upgrades & unattended-upgrades configuration"
  ansible.builtin.template:
    src: 'unattended-upgrades.j2'
    dest: '/etc/apt/apt.conf.d/90-ansible-unattended-upgrades'
    owner: 'root'
    group: 'root'
    mode: '0644'
    validate: '/usr/bin/apt-config --file %s dump | grep -q "APT::Periodic::Unattended-Upgrade.*1"'
